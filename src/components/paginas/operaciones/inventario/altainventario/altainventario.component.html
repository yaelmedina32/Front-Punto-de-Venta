<section class="inventory-container">
    <div class="header-section">
        <h2 class="page-title">Alta de Inventario</h2>
    </div>

    <div class="search-card">
        <div class="search-content">
            <div class="search-field-group">
                <label class="search-label">Seleccione OC:</label>
                <div class="input-group">
                    <mat-form-field appearance="outline" class="oc-input">
                        <mat-label>Folio OC</mat-label>
                        <input type="text" matInput [formControl]="ocCapturada" [matAutocomplete]="auto">
                        <mat-autocomplete #auto="matAutocomplete" autoActiveFirstOption>
                            @for(actual of ordenesCompraFiltered | async; track actual;){
                                <mat-option [value]="actual.ordencompraid"> 
                                    {{actual.ordencompraid}}
                                </mat-option>
                            }
                        </mat-autocomplete>
                    </mat-form-field>
                    <button class="search-btn" (click)="buscarOC()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
                        </svg>
                        Buscar
                    </button>
                </div>
            </div>

            @if(ocSeleccionada.length > 0){
                <div class="action-buttons">
                    <button class="action-btn primary" (click)="inventarearTodo()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/>
                        </svg>
                        Inventariar Todo
                    </button>
                    <button class="action-btn secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>
                        </svg>
                        Guardar sin OC
                    </button>
                </div>
            }
        </div>
    </div>
    <div class="summary-section" *ngIf="ocSeleccionada.length > 0">
        <mat-expansion-panel class="summary-panel">
            <mat-expansion-panel-header>
                <mat-panel-title class="panel-title">Resumen de la OC</mat-panel-title>
                <mat-panel-description class="panel-description">
                    Productos pendientes para inventario
                </mat-panel-description>
            </mat-expansion-panel-header>
            <div class="summary-content">
                @for (item of ocSeleccionada; track $index) {
                    <div class="product-item">
                        <div class="product-info">
                            <span class="info-label">Producto:</span>
                            <span class="info-value">"{{item.nombreproducto}}"</span>
                        </div>
                        <div class="product-info">
                            <span class="info-label">Modelo:</span>
                            <span class="info-value">"{{item.modelo}}"</span>
                        </div>
                        <div class="product-info">
                            <span class="info-label">Cantidad:</span>
                            <span class="info-value">{{item.cantidad}}</span>
                        </div>
                        <div class="product-info">
                            <span class="info-label">Unidad:</span>
                            <span class="info-value">{{item.unidad}}</span>
                        </div>
                        <div class="product-info">
                            <span class="info-label">Precio Unitario:</span>
                            <span class="info-value">{{item.preciounitario | currency: 'USD'}}</span>
                        </div>
                        <div class="product-info">
                            <span class="info-label">En Inventario:</span>
                            <span class="info-value">{{item.cantidadinventario}}</span>
                        </div>
                    </div>
                }
            </div>
        </mat-expansion-panel>
    </div>
    <div class="table-section" *ngIf="ocSeleccionada.length > 0">
        <div class="table-container">
            <mat-table [dataSource]="dataSource" class="inventory-table">
                <ng-container matColumnDef="producto">
                    <mat-header-cell *matHeaderCellDef class="table-header"> 
                        <mat-form-field appearance="outline" class="filter-field">
                            <mat-label>Filtrar producto</mat-label>
                            <input type="text" matInput (keyup)="filtrarDatos($any($event.target).value, 'nombreproducto')">
                        </mat-form-field>    
                    </mat-header-cell>
                    <mat-cell *matCellDef="let element; let i = index;" class="table-cell">
                        <mat-form-field appearance="outline">
                            <mat-label>Producto</mat-label>
                            <mat-select [(value)]="element.nombreproducto" (selectionChange)="calcularRestantes(i, 0)">
                                @for(item of ocSeleccionada; track item){
                                    <mat-option [value]="item.nombreproducto">
                                        {{item.nombreproducto}}
                                    </mat-option>
                                }
                            </mat-select>
                        </mat-form-field>
                    </mat-cell>
                </ng-container>

                <ng-container matColumnDef="dot">
                    <mat-header-cell *matHeaderCellDef class="table-header"> 
                        <mat-form-field appearance="outline" class="filter-field">
                            <mat-label>Filtrar DOT</mat-label>
                            <input type="text" matInput (keyup)="filtrarDatos($any($event.target).value, 'dot')">
                        </mat-form-field>       
                    </mat-header-cell>
                    <mat-cell *matCellDef="let element" class="table-cell">
                        <mat-form-field appearance="outline">
                            <mat-label>DOT</mat-label>
                            <input type="text" matInput [(ngModel)]="element.dot">
                        </mat-form-field>
                    </mat-cell>
                </ng-container>
                
                <ng-container matColumnDef="ubicacion">
                    <mat-header-cell *matHeaderCellDef class="table-header">Ubicación</mat-header-cell>
                    <mat-cell *matCellDef="let element; let i = index;" class="table-cell">
                        <mat-form-field appearance="outline">
                            <mat-label>Ubicación</mat-label>
                            <mat-select [(value)]="element.ubicacionid">
                                @for(ubicacion of ubicaciones; track ubicacion;){
                                    <mat-option [value]="ubicacion.ubicacionid">
                                        {{ubicacion.ubicacion}}
                                    </mat-option>
                                }
                            </mat-select>
                        </mat-form-field>
                    </mat-cell>
                </ng-container>

                <ng-container matColumnDef="cantidad">
                    <mat-header-cell *matHeaderCellDef class="table-header">Cantidad a Inventario</mat-header-cell>
                    <mat-cell *matCellDef="let element; let i = index;" class="table-cell">
                        <mat-form-field appearance="outline">
                            <mat-label>Cantidad</mat-label>
                            <input type="number" [min]="0" matInput [(ngModel)]="element.cantidad" (change)="calcularRestantes(i, 0)">
                        </mat-form-field>
                    </mat-cell>
                </ng-container>

                <ng-container matColumnDef="precioventa">
                    <mat-header-cell *matHeaderCellDef class="table-header">Precio de Venta</mat-header-cell>
                    <mat-cell *matCellDef="let element; let i = index;" class="table-cell">
                        <mat-form-field appearance="outline">
                            <mat-label>Precio de Venta</mat-label>
                            <input type="number" matInput [(ngModel)]="element.precioventa" (change)="validarPrecio(i, $any($event.target).value)">
                        </mat-form-field>
                    </mat-cell>
                </ng-container>

                <ng-container matColumnDef="restante">
                    <mat-header-cell *matHeaderCellDef class="table-header">Cantidad Restante</mat-header-cell>
                    <mat-cell *matCellDef="let element" class="table-cell amount-cell">
                        {{element.cantidadrestante | currency: 'USD'}}
                    </mat-cell>
                </ng-container>
                
                <mat-header-row *matHeaderRowDef="columnasDesplegadas" class="table-header-row"></mat-header-row>
                <mat-row *matRowDef="let row; columns: columnasDesplegadas" class="table-row"></mat-row>
            </mat-table>
        </div>
        
        <div class="table-actions">
            <button class="table-btn add-btn" (click)="agregarProducto()"> 
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                </svg>
                Agregar Producto
            </button>
            <button class="table-btn save-btn" (click)="guardarInventario()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M11 2H9v3h2z"/>
                    <path d="M1.5 0h11.586a1.5 1.5 0 0 1 1.06.44l1.415 1.414A1.5 1.5 0 0 1 16 2.914V14.5a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-13A1.5 1.5 0 0 1 1.5 0M1 1.5v13a.5.5 0 0 0 .5.5H2v-4.5A1.5 1.5 0 0 1 3.5 9h9a1.5 1.5 0 0 1 1.5 1.5V15h.5a.5.5 0 0 0 .5-.5V2.914a.5.5 0 0 0-.146-.353l-1.415-1.415A.5.5 0 0 0 13.086 1H13v4.5A1.5 1.5 0 0 1 11.5 7h-7A1.5 1.5 0 0 1 3 5.5V1H1.5a.5.5 0 0 0-.5.5m3 4a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5V1H4zM3 15h10v-4.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5z"/>
                </svg>
                Guardar Inventario
            </button>
        </div>
    </div>
</section>